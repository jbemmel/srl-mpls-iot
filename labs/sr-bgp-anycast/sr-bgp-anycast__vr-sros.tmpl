{{/* Configure P-to-P interfaces */}}

{{ range $name, $link := .clab_links }}
{{- if $link.port }}
/ configure port {{ $link.port}} connector breakout c1-100g
/ configure port {{ $link.port}} admin-state enable
/ configure port {{ $link.port}}/1 admin-state enable
/ configure router interface {{ $link.clab_link_name }} port {{ $link.port}}/1
{{- if $link.clab_link_ip }}
/ configure router interface {{ $link.clab_link_name }} ipv4 primary address {{ ip $link.clab_link_ip }} prefix-length {{ ipmask $link.clab_link_ip }}
{{- end }}
{{- end }}
{{- end -}}

{{/* Configure system interface */}}
{{- if .system_ip }}
/ configure router interface system ipv4 primary address {{ .system_ip }}
/ configure router interface system ipv4 primary prefix-length 32

{{/* policy to allow system ip */}}
/ configure policy-options prefix-list system_ip prefix {{ .system_ip }}/32 type exact
/ configure policy-options policy-statement system_ip entry 10 from prefix-list system_ip
/ configure policy-options policy-statement system_ip entry 10 action action-type accept
{{- end }}

/ configure policy-options policy-statement accept-all default-action action-type accept

{{/* Configure anycast loopback interface */}}
{{- if .anycast_nexthop_ip }}
/ configure router interface lo0 loopback ipv4 primary address {{ .anycast_nexthop_ip }}
/ configure router interface lo0 ipv4 primary prefix-length 32

{{/* policy to allow anycast ip */}}
/ configure policy-options prefix-list anycast_ip prefix {{ .anycast_nexthop_ip }}/32 type exact
/ configure policy-options policy-statement system_ip entry 20 from prefix-list anycast_ip
/ configure policy-options policy-statement system_ip entry 20 action action-type accept

{{/* policy to rewrite nexthop to anycast ip, to be applied towards RR *in overlay* */}}
/ configure policy-options policy-statement rewrite_nexthop_to_anycast entry 10 from prefix-list anycast_ip
/ configure policy-options policy-statement rewrite_nexthop_to_anycast entry 10 action action-type accept
/ configure policy-options policy-statement rewrite_nexthop_to_anycast default-action action-type accept
/ configure policy-options policy-statement rewrite_nexthop_to_anycast default-action next-hop {{ .anycast_nexthop_ip }}
{{- end }}

{{- if .as }}
{{/* Underlay Config */}}
/ configure router autonomous-system {{ .as }}
/ configure router bgp ebgp-default-reject-policy import false
/ configure router bgp ebgp-default-reject-policy export true
/ configure router bgp min-route-advertisement 1
{{/* / configure router bgp group underlay family ipv4 true */}}
/ configure router bgp group underlay export policy system_ip
{{- end }}

{{/* Configure underlay ebgp on links */}}
{{- range $name, $link := .clab_links }}
  {{- if true }}
/ configure router bgp neighbor {{ ip $link.clab_far.clab_link_ip }} group underlay
/ configure router bgp neighbor {{ ip $link.clab_far.clab_link_ip }} peer-as {{(index $.clab_nodes $link.clab_far.clab_node).as}}
  {{- end -}}
{{- end -}}

{{/* RR Config */}}
/ configure router bgp group RR family ipv4 true
/ configure router bgp group RR peer-as {{ $.overlay_as }}
/ configure router bgp group RR local-as as-number {{ $.overlay_as }}
/ configure router bgp group RR export policy accept-all
{{- if .anycast_nexthop_ip }}
/ configure router bgp group RR export policy rewrite_nexthop_to_anycast
{{- end }}
{{- range $name, $node := $.clab_nodes }}
{{- if .cluster_id }}
/ configure router bgp neighbor {{ $node.system_ip }} group RR
{{- end -}}
{{- end -}}
